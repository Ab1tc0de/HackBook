# 基础域概念

## 域主要名称
  **什么是 AD**：
AD 指的就是 Active Directory 服务，一般存在与 windows server 中，用于管理在域（Domain）中的所有客户机
  **Domain 域**：
类似网络中的域名，但是这个域名只会在域中使用，并且在 DC（Domain Controller）中会含有一个 DNS 服务来给整个域环境提供域名服务
  **DC 域控制器**：
安装了活动目录 AD 的机器称为 DC
  **OU 组织单位**：
OU 类似于文件系统文件夹，因为它们是用于存储域内对象的容器
  **LDAP 轻量级目录访问协议**：
AD 枚举依赖于 LDAP。当域机器搜索对象 (如打印机)或查询用户或组对象时，LDAP 被用作查询的通信通道。换句话说，LDAP 是用于与 ActiveDirectory 通信的协议。完整的 LDAP 路径，我们需要三个参数: HostName、 PortNumber 和 distinguishedName
`LDAP://HostName[:PortNumber][/DistinguishedName]`
主机名可以是计算机名、 IP 地址或域名。
虽然这可能仍然会返回有效的信息，但它可能不是最优的枚举方法。事实上，为了使我们的枚举尽可能准确，我们应该查找包含最新信息的 DC。这就是所谓的主要网域控制器 (PDC)。要找到 PDC，我们需要找到保存 PdcRoleOwner 属性的 DC。我们最终将使用 PowerShell 和一个特定的。NET 类来查找这个。
根据 Microsoft 的文档，LDAP 连接的 PortNumber 是可选的。在我们的示例中，我们将不添加端口号，因为它将根据是否使用 SSL 连接自动选择端口。但是，值得注意的是，如果我们在将来遇到使用非默认端口的域，我们可能需要手动将其添加到脚本中。
最后，DisinguishedName (DN)  是 LDAP 路径的一部分。DN 是唯一标识 AD 中对象 (包括域本身)的名称。如果我们不熟悉 LDAP，那么这可能有些令人困惑，因此让我们进一步了解一下细节。
最后 DN 可能是这样:  ` CN=Stephanie,CN=Users,DC=corp,DC=com`
  **PDC 主域控**：
在一个域中可能不知含有一个 DC 域控，要保持信息最新，从中选出一个域控作为主域控
  **DN 可辩名称**：
DN 是唯一标识 AD 中对象 (包括域本身)的名称
  **SPN服务主题名称**：
在域环境中运行的大量应用包含了多种资源，为资源的合理分组、分类和再分配提供了便利。微软给域内的每种资源分配了不同的服务主体名称(Service Principal Name, SPN)




# AD认证方式

## NTLM认证
当客户端通过 IP 地址(而不是主机名)向服务器进行身份验证时，或者当用户试图向没有在 ActiveDirectory 集成的 DNS 服务器上注册的主机名进行身份验证时，将使用 NTLM 身份验证。同样，第三方应用程序可能选择使用 NTLM 身份验证而不是 Kerberos
  **NTLM认证流程**：
（1）Client计算机根据用户的密码计算一个加密hash，称为 NTLM hash。
（2）客户端计算机将用户名发送到服务器，服务器将返回一个随机值，称为 nonce 或 Challenge。
（3）客户端使用 NTLM hash加密 nonce，并将其发送到服务器。
（4）（5）服务器将响应内容以及用户名和 nonce 发送给网域控制器DC。
（6）然后由网域控制器DC执行验证，因为它已经知道所有用户的 NTLM hash。网域控制器用提供的用户名的 NTLM 散列对 nonce 本身进行加密，并将其与从服务器收到的响应进行比较。如果两者相等，则身份验证请求成功。
（7）认证成功
由于 NTLM 认证方式过于广泛，大量应用默认使用 NTLM 认证，尽管 NTLM 含有缺陷


![[Pasted image 20240217204926.png]]


## Kerberos 认证
这两种协议NTLM和Kerberos(基于底层系统)之间的一个关键区别是，使用 NTLM 身份验证时，客户机通过应用程序服务器本身启动身份验证过程。另一方面，Kerberos 客户端身份验证涉及使用密钥分发中心(KDC)的网域控制器。客户端启动身份验证过程时使用的是 KDC，而不是应用服务器。KDC 服务在每个网域控制器上运行，负责向用户和计算机提供会话票和临时会话密钥。
  **认证流程**：
 （1）当用户登录到他们的工作站时，一个身份验证服务器请求(AS-REQ)被发送到网域控制器。网域控制器作为 KDC，也维护身份验证服务器服务。AS-REQ 包含一个时间戳，该时间戳使用从用户的密码和用户名派生的hash进行加密。
当网域控制器收到请求时，它会在 ntds.dit文件中查找与特定用户关联的密码hash，并尝试解密时间戳。如果解密过程成功且时间戳不是重复的，则认证被认为是成功的。如果时间戳是重复的，则可能表明存在潜在的重播攻击。
（2）网域控制器用身份验证服务器答复(AS-REP)回复客户端。
由于 Kerberos 是一个无状态协议，因此 AS-REP 包含一个会话密钥和一个 Ticket grantTicket (TGT)。会话密钥使用用户的密码hash进行加密，客户端可以对其进行解密，然后重用。TGT 包含有关用户、域、时间戳、客户机的 IP 地址和会话密钥的信息。
为了避免篡改，TGT 使用只有 KDC 知道的秘密密钥(krbtgt帐户的 NTLM hash)进行加密，客户机无法解密。一旦客户机接收到会话密钥和 TGT，KDC 就认为客户机身份验证完成了。默认情况下，TGT 的有效时间为10小时，之后进行更新。此更新不要求用户重新输入密码。
**前两步进行完，就已经通过KDC的认证了**
（3）当用户希望访问域的资源(如网络共享或邮箱)时，必须再次与 KDC 联系。
这一次，客户机构造了一个 Ticket Granting Service Request (TGS-REQ)数据包，该数据包由当前用户和一个时间戳组成，该时间戳用会话密钥、资源名称和加密的 TGT 进行加密。
接下来，KDC 上的票据授予服务接收 TGS-REQ，如果域中存在资源，则使用只有 KDC 知道的秘密密钥对 TGT 进行解密。然后从 TGT 中提取会话密钥，并用于解密请求的用户名和时间戳。
此时，KDC 执行几项检查:
  （TGT 必须有一个有效的时间戳。）
  （来自 TGS-REQ 的用户名必须与来自 TGT 的用户名匹配。）
  （客户端 IP 地址需要与 TGT IP 地址一致。）
（4）如果这个验证过程成功，票证授予服务将使用 Ticket Granting Server Response (TGS-REP)对客户机进行响应。
TGS-REP这个包包含三个部分:
  （已授予其访问权限的服务的名称。）
  （要在客户端和服务之间使用的会话密钥。）
  （包含用户名和组成员身份以及新创建的会话密钥的服务票据。）
服务票证的服务名称和会话密钥使用与创建 TGT 相关联的原始会话密钥进行加密。服务票证使用注册到相关服务的服务帐户的密码哈希进行加密。
一旦 KDC 的身份验证过程完成，并且客户机同时具有会话密钥和服务票证，服务身份验证就开始了。
（5）客户机向应用服务器发送一个 Application Request (AP-REQ) ，其中包括用户名和一个时间戳，该时间戳使用与服务票证关联的会话密钥以及服务票证本身进行加密。
应用服务器使用服务帐户密码散列解密服务票据，并提取用户名和会话密钥。然后使用后者从 AP-REQ 解密用户名。如果 AP-REQ 用户名与服务票证中解密的用户名匹配，则接受请求。在授予访问权限之前，服务检查服务票证中提供的组成员关系，并向用户分配适当的权限，之后用户可以访问请求的服务。


![[Pasted image 20240217211200.png]]
